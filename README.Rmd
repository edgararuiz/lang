---
output: github_document
---

<!-- TODO: Add clarification regarding using the two letter language designation ISO 639 -->

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# lang

<!-- badges: start -->
<!-- badges: end -->

Use an **LLM to translate a function's help documentation on-the-fly**. `lang` 
overrides the `?` and `help()` functions in your R session. If you are using 
RStudio or Positron, the translated help page will appear in the usual help 
pane.

## Installation

To install the GitHub vesion of `lang`, use:

```r
install.packages("pak")
pak::pak("edgararuiz/lang")
```

## Using `lang`

If you have not used `mall` yet, then the first step is to set it up. Feel free
to follow the instructions in that package's
[Get Started](https://mlverse.github.io/mall/#get-started) page. Setting up
your LLM and `mall` should be a one time process.

On an every day R session, you'll just need to load `lang` and then tell
it which model to run using `llm_use()`: 

```
library(lang)

llm_use("ollama", "llama3.2", seed = 100)
```

After that, simply use `?` to trigger and display the translated documentation.
During translation, `lang` will display its progress by showing which section
of the documentation is currently translating: 

```
> ?lm
Translating: Title
```

If your environment is set to use the Spanish language, the help pane should
display this:

<img src="man/figures/lm-spanish.png" align="center" 
alt="Screenshot of the lm function's help page in Spanish"/>

R enforces the printed name of each section, so they cannot be
translated. So titles such as Description, Usage and Arguments will always
remain untranslated. 

### Translation is not perfect

As you can imagine, the quality of translation will mostly depend on the LLM 
being used. This solution is meant to be as helpful as possible, but 
acknowledging that at this stage of LLMs, only a human curated translation
will be the best solution. Having said that, I believe that even an imperfect
translation could go a long way with someone who is struggling to understand
how to use a specific function in a package, and may also struggle with the
English language.

### Debug

If the original English help page displays, check your environment variables:

```{r}
Sys.getenv("LANG")
Sys.getenv("LANGUAGE")
```

In my case, `lang` recognizes that the environment is set to English, because
of the `en` code in the variable. If your `LANG` variable is set to `en_...` 
then no translation will occur.

If this is your case, set the `LANGUAGE` variable to your preference. You can
use the full language name, such as 'spanish', or 'french', etc.  You can use
`Sys.setenv(LANGUAGE = "[my language]")`, or, for a more permanent solution, 
add the entry to your your .Renviron file (`usethis::edit_r_environ()`). 


## How it works

The language that the help documentation will be translated to, is determined by
one of the following two environment variables. In order of priority, the 
variables are:

1. `LANGUAGE`
1. `LANG`

It is likely that your `LANG` variable  already defaults to your locale. 
For example, mine is set to: `en_US.UTF-8` (That means English, United States). 
For someone in France, the locale would be  something such as `fr_FR.UTF-8`. 
Llama3.2, recognizes these UTF locales, and using `lang`, calling `?` will 
result in translating the function's help documentation into French. 

It uses the `mall` package as the integration point with the LLM. Under the hood,
it runs `llm_vec_translate()` multiple times to translate the most common 
sections of the help documentation (e.g.: Title, Description, Details,
Arguments, etc.).  If `lang` determines that your environment is set to use 
English, it will simply display the original documentation. 

## Package Developers

You may want to provide translations of your documentation as part of your 
package.`lang` includes an entire infrastructure to help you to do the following:

- Let the LLM take the first pass at translating your documentation
- Easily edit the translations. This means, either you, or a collaborator, can 
fine tune the new files
- Include the translated Rd files as part of your package
- Have `?` and `help()` pull from your translated documents 

### LLM First pass

While inside your package's project, use `translate_roxygen()` to have `lang`
translate all of your documentation to the desired language. The function call
must include the target language, and the sub-folder to save the translated
files to:

```r
translate_roxygen("spanish", "es")
```

That function call will iterate through your **'R/'** folder and translate all of
your [`roxygen2`](https://roxygen2.r-lib.org/index.html) documentation. The 
new Roxygen documents will be saved, by default, to a new **'man-lang/'** folder. 
Make sure to add the new folder to your project **'.Rbuildignore'** file 
(`^man-lang$`)

For this package, making that function call creates this console output:

```r
> translate_roxygen("spanish", "es")

── `lang` translating Roxygen into 'spanish' 
ℹ Loading lang
[1/7] R/help-shims.R --> man-lang/es/help-shims.R
[2/7] R/lang-help.R --> man-lang/es/lang-help.R
[3/7] R/lang.R --> man-lang/es/lang.R
[4/7] R/mall-reexports.R --> man-lang/es/mall-reexports.R
[5/7] R/process-roxygen.R --> man-lang/es/process-roxygen.R
[6/7] R/translate-roxygen.R --> man-lang/es/translate-roxygen.R
[7/7] R/utils.R --> man-lang/es/utils.R
```

### Edit the translations

As mentioned in the previous section, `lang` translates the functions'
Roxygen comments. This approach allows you as the developer to easily edit the
output.

For the `lang_help()` function, in the **'R/lang-help.R'** script, the top of
the documentation looks like this:

```r
#' Translates help
#' @description
#' Translates a given topic into a target language. It uses the `lang` argument
#' to determine which language to translate to. If not passed, this function will
#' look for a target language in the LANG and LANGUAGE environment variables to
#' determine the target language. If the target language is English, no translation
#' will be processed, so the help returned will be the original package's
#' documentation.
#'
#' @param topic The topic to search for
#' @param package The R package to look for the topic
#' @param lang Language to translate the help to
#' @param type Produce "html" or "text" output for the help. It default to
#' `getOption("help_type")`
...
```

And this is what the translation in **'man-lang/es/lang.R'** looks like: 

```r
#' Ayuda en traducción
#' @description La función traduce un tema dado a un idioma objetivo. Utiliza
#' el argumento `lang` para determinar qué idioma traducir. Si no se pasa, esta
#' función busca un idioma objetivo en las variables de entorno LANG y LANGUAGE
#' para determinarlo. Si el idioma objetivo es inglés, no se procesa la
#' traducción, por lo que se devuelve la documentación original del paquete.
#' @param topic  El tema de búsqueda principal.
#' @param package  Paquete R para buscar el tema.
#' @param lang  Please provide the text you'd like me to translate.
#' @param type  Utilice "html" o "texto" como salida para la ayuda, de lo
#' contrario se utilizará el valor por defecto de `getOption("help_type")`.
...
```

Editing an R scripts Roxygen comments is a lot easier than editing an Rd file,
additionally, this solution integrates better with the usual package development
process.

It also opens the possibility to have collaborators to submit PRs to your package's
repository with edits to the translation, or even submit brand new translations.

### Include translations in your package

The Rd help files are still the best way for R to process and display your 
help files. The second, and final step, will be to have `lang` create the
Rd files based on the translated Roxygen comments, simply run:

```r
process_roxygen()
```

That function will iterate through all the language sub-folders in 
**'man-lang/'** to process the Rd files. The resulting Rd files will be saved to
**'inst/man-lang/'**. Please keep in mind that this step does not need an LLM
to work. It is only  creating the Rd files, and putting them in the correct 
location. 

Under the hood, `lang` creates temporary copies of your package, replaces the 
scripts in the 'R' folder with your translations, and then runs the 
`roxygen2::roxygenize()` function. This ensures that the Rd creation is as 
close as possible as if you were running `devtools::document()` during your
package development. 

For this package, making that function call creates this console output:

```r
> process_roxygen()

── Creating Rd files for 'es' 
- inst/man-lang/es/help.Rd
- inst/man-lang/es/lang_help.Rd
- inst/man-lang/es/process_roxygen_folder.Rd
- inst/man-lang/es/translate_roxygen.Rd
```

### Using your package's translations

The end-user can easily access your translations by making sure that `lang`
is loaded to their R session:

```r
library(lang)

Sys.setenv(LANGUAGE = "spanish")

?lang_help
```

`lang` always looks first in the **'inst/man-lan'** folder of your package 
to see if there is a folder matching the end-user's language. If it does not
find one, it will then trigger a live translation of the function. This would be
the case if the user expect a French translation, but you only included a
Spanish one. 

Instead of having the user wait for the LLM to complete the translation, if 
`lang` finds a matching translation in your package, the help page will appear
almost instantly. 







